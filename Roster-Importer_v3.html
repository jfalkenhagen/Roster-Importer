<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport tag optimizes the zoom/scale for iPhone screens -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roster to Calendar</title>
    <!-- SheetJS Library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; /* iOS Blue */
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --error: #FF3B30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #666;
        }

        /* Large touch targets for mobile */
        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px; /* Prevents auto-zoom on iPhone */
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:active {
            opacity: 0.8;
        }

        .suggestions {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            background: white;
            position: absolute;
            width: calc(100% - 48px); /* Adjust for container padding */
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .error { background-color: #ffe5e5; color: var(--error); }
        .success { background-color: #e5ffe5; color: #34C759; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Roster Importer</h1>
    
    <label for="upload">1. Select Excel File</label>
    <input type="file" id="upload" accept=".xlsx, .xls">

    <div id="search-container" class="hidden">
        <label for="nameInput">2. Search Name</label>
        <div style="position: relative;">
            <input type="text" id="nameInput" placeholder="e.g., Angela Thomson" autocomplete="off">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <button id="generateBtn">Add to Calendar</button>
    </div>

    <div id="status"></div>
</div>

<script>
    let rosterData = [];
    let rosterDates = [];
    let staffNames = []; // Array to store extracted names

    // 1. Listen for File Upload
    document.getElementById('upload').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            
            // Assume first sheet
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // Convert to JSON with header array to analyze structure
            // Using logic derived from source [2] where headers are row 4/5
            const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            processExcelData(rawData);
        };
        reader.readAsArrayBuffer(file);
    }

    // 2. Process Excel Structure
    function processExcelData(data) {
        // Reset
        rosterData = data;
        staffNames = [];
        rosterDates = [];

        // Attempt to find the Header row containing "SURNAME" or dates
        // Based on [2], dates appear around row 4 or 5.
        let headerRowIndex = -1;
        
        for(let i=0; i<data.length; i++) {
            const row = data[i];
            // Check for a row that has many dates or the word "SURNAME"
            if (row.some(cell => typeof cell === 'string' && cell.toUpperCase().includes('SURNAME'))) {
                headerRowIndex = i;
                break;
            }
        }

        if (headerRowIndex === -1) {
            showStatus("Error: Could not find 'SURNAME' header in spreadsheet.", "error");
            return;
        }

        // Extract Dates (Assumed to be in the row BEFORE or SAME as header, usually)
        // In source [2], dates are in row 5, Names start lower. 
        // We will scan the header row and the row above it for Date objects.
        const dateRow = data[headerRowIndex - 1] || data[headerRowIndex]; 
        
        dateRow.forEach((cell, index) => {
            if (cell instanceof Date) {
                rosterDates.push({ index: index, date: cell });
            } else if (typeof cell === 'string' && !isNaN(Date.parse(cell))) {
                 // Try to parse string dates
                 rosterDates.push({ index: index, date: new Date(cell) });
            }
        });

        // Extract Names (Column 0 / A)
        for (let i = headerRowIndex + 1; i < data.length; i++) {
            const row = data[i];
            // Source [2] format: "THOMSON, Angela"
            if (row[0] && typeof row[0] === 'string') {
                staffNames.push(row[0]);
            }
        }

        // UI Updates
        if (staffNames.length > 0) {
            document.getElementById('search-container').classList.remove('hidden');
            showStatus(`Loaded ${staffNames.length} staff members.`, "success");
        } else {
            showStatus("File loaded, but no names found in Column A.", "error");
        }
    }

    // 3. Autocomplete & Search Logic
    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');

    nameInput.addEventListener('keyup', function() {
        const input = this.value.toLowerCase();
        suggestionsBox.innerHTML = '';
        
        if (input.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        // Fuzzy-ish matching: Split input "Angela Thomson" -> ["angela", "thomson"]
        // Check if BOTH parts exist in the target name "THOMSON, Angela"
        const searchParts = input.split(/[\s,]+/);

        const matches = staffNames.filter(name => {
            const lowerName = name.toLowerCase();
            return searchParts.every(part => lowerName.includes(part));
        });

        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = match;
                div.onclick = function() {
                    nameInput.value = match; // Set exact value
                    suggestionsBox.style.display = 'none';
                };
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    // Hide suggestions if clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== nameInput) {
            suggestionsBox.style.display = 'none';
        }
    });

    // 4. Generate Calendar Logic
    document.getElementById('generateBtn').addEventListener('click', function() {
        const selectedName = nameInput.value;
        if (!selectedName) {
            showStatus("Please enter a name.", "error");
            return;
        }

        // Find the row for this person
        const targetRow = rosterData.find(row => row[0] === selectedName);

        if (!targetRow) {
            showStatus(`Could not find "${selectedName}". Please select a name from the list.`, "error");
            return;
        }

        let events = [];
        
        // Loop through the columns where we found dates
        rosterDates.forEach(dateObj => {
            const colIndex = dateObj.index;
            const shiftContent = targetRow[colIndex];

            if (shiftContent && typeof shiftContent === 'string') {
                const shiftInfo = parseShift(shiftContent, dateObj.date);
                if (shiftInfo) {
                    events.push(shiftInfo);
                }
            }
        });

        if (events.length === 0) {
            showStatus("No shifts found for this user.", "error");
            return;
        }

        downloadICS(events, selectedName);
    });

    // Parse specific shift codes found in Source [2] (e.g., "0800-1630")
    function parseShift(cellText, date) {
        // Ignore "X" (Day off) or empty
        if (!cellText || cellText.trim().toUpperCase() === 'X') return null;

        // Check for times: Pattern 4 digits - 4 digits (e.g. 0800-1630)
        const timeMatch = cellText.match(/(\d{4})-(\d{4})/);
        
        let title = `Shift: ${cellText}`;
        let startDate = new Date(date);
        let endDate = new Date(date);

        if (timeMatch) {
            const startStr = timeMatch[1];
            const endStr = timeMatch[2];

            startDate.setHours(startStr.substr(0,2), startStr.substr(2,2), 0);
            endDate.setHours(endStr.substr(0,2), endStr.substr(2,2), 0);

            // Handle overnight shifts (if end time is smaller than start time)
            if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1);
            }
        } else {
            // All day event for things like "A/L" (Annual Leave) or irregular codes
            // We set it as a full day event
            startDate.setHours(8, 0, 0); // Default 8am
            endDate.setHours(17, 0, 0); // Default 5pm
        }

        return {
            title: title,
            start: startDate,
            end: endDate
        };
    }

    // 5. Create and Download ICS File
    function downloadICS(events, name) {
        let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//RosterApp//EN\n";

        events.forEach(ev => {
            icsContent += "BEGIN:VEVENT\n";
            icsContent += `SUMMARY:${ev.title}\n`;
            icsContent += `DTSTART:${formatDateICS(ev.start)}\n`;
            icsContent += `DTEND:${formatDateICS(ev.end)}\n`;
            icsContent += "END:VEVENT\n";
        });

        icsContent += "END:VCALENDAR";

        const blob = new Blob([icsContent], { type: 'text/calendar' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name.replace(/[^a-z0-9]/gi, '_')}_Roster.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showStatus("Calendar file generated! Tap the file to add to iPhone Calendar.", "success");
    }

    function formatDateICS(date) {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = type; // "error" or "success"
        el.style.display = 'block';
    }
</script>

</body>
</html>