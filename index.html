<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roster to Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #007AFF;
            --primary-dark: #0051D5;
            --secondary: #5856D6;
            --success: #34C759;
            --error: #FF3B30;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 32px 24px;
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header-icon {
            font-size: 48px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .step-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 14px;
            font-weight: 700;
            margin-right: 8px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        input[type="file"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }

        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .suggestions {
            border: 2px solid var(--border);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
        }

        .suggestion-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 15px;
            transition: background 0.2s ease;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:active {
            background: rgba(0, 122, 255, 0.1);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        button {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: rgba(0, 122, 255, 0.05);
        }

        #status {
            margin-top: 20px;
            padding: 14px 16px;
            border-radius: 12px;
            text-align: center;
            display: none;
            font-size: 14px;
            line-height: 1.6;
            animation: slideUp 0.3s ease-out;
        }

        .error { 
            background: rgba(255, 59, 48, 0.1);
            color: var(--error);
            border: 2px solid var(--error);
        }
        
        .success { 
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .hidden { 
            display: none !important; 
        }

        .instructions {
            background: linear-gradient(135deg, rgba(88, 86, 214, 0.1), rgba(102, 126, 234, 0.1));
            border-left: 4px solid var(--secondary);
            padding: 16px;
            margin-top: 20px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.8;
            display: none;
        }

        .instructions.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        .instructions strong {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--secondary);
        }

        .instructions ol {
            margin: 8px 0 0 20px;
        }

        .instructions li {
            margin: 6px 0;
        }

        .search-wrapper {
            position: relative;
        }

        @media (max-width: 480px) {
            .container {
                padding: 24px 20px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-icon">üìÖ</div>
        <h1>Roster Importer</h1>
        <p class="subtitle">Convert your roster to iPhone calendar</p>
    </div>
    
    <div class="form-group">
        <label><span class="step-badge">1</span>Upload Excel File</label>
        <input type="file" id="upload" accept=".xlsx, .xls">
    </div>

    <div id="search-container" class="hidden">
        <div class="form-group">
            <label><span class="step-badge">2</span>Search Your Name</label>
            <div class="search-wrapper">
                <input type="text" id="nameInput" placeholder="e.g., Megan Falkenhagen" autocomplete="off">
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>

        <div class="button-group">
            <button id="downloadBtn" class="btn-primary">
                üì• Download Calendar File
            </button>
            <button id="shareBtn" class="btn-secondary">
                üì§ Share/Email File
            </button>
        </div>

        <div id="instructions" class="instructions">
            <strong>üì≤ To Import on iPhone:</strong>
            <ol>
                <li><strong>Download method:</strong> Tap "Download", save to Files app, then open the .ics file from Files</li>
                <li><strong>Share method:</strong> Tap "Share/Email", choose Mail, send to yourself, then open the email and tap the attachment</li>
                <li>iOS will show "Add All" - tap it to import shifts to your Calendar</li>
            </ol>
        </div>
    </div>

    <div id="status"></div>
</div>

<script>
    let rosterData = [];
    let staffList = [];
    let shiftDates = [];
    let weekStartDate = null;

    document.getElementById('upload').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        showStatus("üìÇ Loading file...", "success");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                processExcelData(rawData);
            } catch (error) {
                showStatus("‚ùå Error reading file: " + error.message, "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Parse Australian date format (DD/MM/YYYY or D/M/YYYY)
    function parseAustralianDate(dateString) {
        // Try to extract date from "DATE: 2/16/2026" format
        const match = dateString.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (match) {
            const day = parseInt(match[1]);
            const month = parseInt(match[2]);
            const year = parseInt(match[3]);
            
            // Australian format: day/month/year
            // Create date with month-1 because JS months are 0-indexed
            return new Date(year, month - 1, day);
        }
        return null;
    }

    function processExcelData(data) {
        rosterData = data;
        staffList = [];
        shiftDates = [];
        weekStartDate = null;

        // FLEXIBLE WEEK START DATE FINDER - with Australian date format support
        for (let rowIndex = 0; rowIndex < Math.min(data.length, 7); rowIndex++) {
            const row = data[rowIndex];
            if (!row) continue;
            
            for (let colIndex = 0; colIndex < Math.min(row.length, 15); colIndex++) {
                const cell = row[colIndex];
                
                // Check if cell is a Date object
                if (cell instanceof Date && !isNaN(cell)) {
                    if (cell.getFullYear() >= 2020 && cell.getFullYear() <= 2030) {
                        weekStartDate = cell;
                        console.log(`Found week start date: ${weekStartDate.toLocaleDateString('en-AU')} at row ${rowIndex + 1}, col ${String.fromCharCode(65 + colIndex)}`);
                        break;
                    }
                }
                
                // Check if cell contains "DATE:" text - parse as Australian format
                if (typeof cell === 'string' && cell.includes('DATE:')) {
                    const parsedDate = parseAustralianDate(cell);
                    if (parsedDate && !isNaN(parsedDate)) {
                        weekStartDate = parsedDate;
                        console.log(`Found week start date from text (AU format): ${weekStartDate.toLocaleDateString('en-AU')}`);
                        break;
                    }
                }
                
                // Check for Excel serial date number
                if (typeof cell === 'number' && cell > 40000 && cell < 50000) {
                    weekStartDate = new Date((cell - 25569) * 86400 * 1000);
                    console.log(`Found week start date from serial: ${weekStartDate.toLocaleDateString('en-AU')}`);
                    break;
                }
            }
            
            if (weekStartDate) break;
        }

        if (!weekStartDate || isNaN(weekStartDate)) {
            showStatus("‚ùå Could not find week starting date in rows 1-7. Please check file format.", "error");
            return;
        }

        // Find dates in row 7 (index 6), starting from column E (index 4)
        const dateRow = data[6];
        
        if (!dateRow) {
            showStatus("‚ùå Could not find row 7 with day numbers.", "error");
            return;
        }
        
        for (let colIndex = 4; colIndex < dateRow.length; colIndex++) {
            const cell = dateRow[colIndex];
            if (typeof cell === 'number' && cell >= 1 && cell <= 31) {
                // Use the week start date's month and year
                const date = new Date(weekStartDate.getFullYear(), weekStartDate.getMonth(), cell);
                shiftDates.push({ colIndex: colIndex, date: date });
            }
        }

        if (shiftDates.length === 0) {
            showStatus("‚ùå No dates found in row 7. Please check file format.", "error");
            return;
        }

        // Find staff names
        for (let rowIndex = 7; rowIndex < data.length; rowIndex++) {
            const row = data[rowIndex];
            const nameCell = row[0];
            
            if (nameCell && typeof nameCell === 'string') {
                if (nameCell.includes(',')) {
                    const parts = nameCell.split(',');
                    if (parts.length >= 2) {
                        const surname = parts[0].trim();
                        const firstname = parts[1].trim().split(/\s+/)[0];
                        
                        if (!surname.toUpperCase().includes('TOTAL') && 
                            !surname.toUpperCase().includes('SURNAME') &&
                            !surname.toUpperCase().includes('CASUAL') &&
                            surname.length > 1 && firstname.length > 0) {
                            staffList.push({
                                fullName: nameCell,
                                firstName: firstname,
                                rowIndex: rowIndex
                            });
                        }
                    }
                }
            }
        }

        if (staffList.length > 0) {
            document.getElementById('search-container').classList.remove('hidden');
            showStatus(`‚úÖ Loaded ${staffList.length} staff members and ${shiftDates.length} days (starting ${weekStartDate.toLocaleDateString('en-AU', {day: 'numeric', month: 'long', year: 'numeric'})}).`, "success");
            document.getElementById('nameInput').focus();
        } else {
            showStatus("‚ùå No staff names found. Check that names are in format 'SURNAME, Firstname'.", "error");
        }
    }

    // Autocomplete
    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');

    nameInput.addEventListener('input', function() {
        const input = this.value.toLowerCase().trim();
        suggestionsBox.innerHTML = '';
        
        if (input.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const matches = staffList.filter(staff => {
            return staff.fullName.toLowerCase().includes(input) ||
                   staff.firstName.toLowerCase().includes(input);
        }).slice(0, 10);

        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(staff => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = staff.fullName;
                div.addEventListener('click', function() {
                    nameInput.value = staff.fullName;
                    suggestionsBox.style.display = 'none';
                });
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target !== nameInput) {
            suggestionsBox.style.display = 'none';
        }
    });

    // Download Button
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const result = generateCalendar();
        if (!result) return;

        const blob = new Blob([result.icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${result.firstName}_Roster.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        document.getElementById('instructions').classList.add('show');
        showStatus("‚úÖ Calendar file downloaded! Save to Files, then tap to open in Calendar.", "success");
    });

    // Share/Email Button
    document.getElementById('shareBtn').addEventListener('click', function() {
        const result = generateCalendar();
        if (!result) return;

        const file = new File(
            [result.icsContent], 
            `${result.firstName}_Roster.ics`, 
            { type: 'text/calendar' }
        );

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                title: `${result.firstName}'s Work Roster`,
                text: `Roster calendar for ${result.fullName}`,
                files: [file]
            }).then(() => {
                document.getElementById('instructions').classList.add('show');
                showStatus("‚úÖ File shared! Choose Mail to email it to yourself.", "success");
            }).catch((err) => {
                if (err.name !== 'AbortError') {
                    showStatus("‚ùå Share failed. Try the Download button instead.", "error");
                }
            });
        } else {
            const blob = new Blob([result.icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${result.firstName}_Roster.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showStatus("‚úÖ File downloaded (Share not supported on this browser).", "success");
        }
    });

    function generateCalendar() {
        const selectedName = nameInput.value.trim();
        
        if (!selectedName) {
            showStatus("‚ö†Ô∏è Please enter a name.", "error");
            return null;
        }

        const staff = staffList.find(s => 
            s.fullName.toLowerCase() === selectedName.toLowerCase()
        );

        if (!staff) {
            const similar = staffList.filter(s => 
                s.fullName.toLowerCase().includes(selectedName.toLowerCase())
            ).slice(0, 3);
            
            let errorMsg = `‚ùå Could not find "${selectedName}".`;
            if (similar.length > 0) {
                errorMsg += `\n\nDid you mean:\n‚Ä¢ ${similar.map(s => s.fullName).join('\n‚Ä¢ ')}`;
            }
            showStatus(errorMsg, "error");
            return null;
        }

        const topRow = rosterData[staff.rowIndex];
        const bottomRow = rosterData[staff.rowIndex + 1];

        let events = [];

        shiftDates.forEach(dateInfo => {
            const colIndex = dateInfo.colIndex;
            const date = dateInfo.date;
            
            const topCell = topRow[colIndex];
            const bottomCell = bottomRow[colIndex];

            const shiftInfo = parseShift(topCell, bottomCell, date, staff.firstName);
            if (shiftInfo) {
                events.push(shiftInfo);
            }
        });

        if (events.length === 0) {
            showStatus("‚ùå No shifts found for this person.", "error");
            return null;
        }

        return {
            icsContent: createICSContent(events, staff.fullName),
            firstName: staff.firstName,
            fullName: staff.fullName
        };
    }

    function parseShift(topCell, bottomCell, date, firstName) {
        if (!topCell && !bottomCell) return null;
        
        let topStr = typeof topCell === 'string' ? topCell.trim() : '';
        let bottomStr = typeof bottomCell === 'string' ? bottomCell.trim() : '';
        
        // Skip non-work indicators
        if (topStr.toUpperCase() === 'X' || topStr.toUpperCase() === 'RDO' ||
            topStr.includes('SECONDMENT') || topStr.includes('LWOP') ||
            topStr.includes('A/L') || topStr.includes('ML') ||
            topStr.toUpperCase() === 'C' || topStr.toUpperCase() === 'R') {
            return null;
        }

        // Extract circled number and o/c notation
        let oncallNumber = '';
        let isOncall = false;
        
        const circledMatch = topStr.match(/[‚ë†‚ë°‚ë¢]/);
        if (circledMatch) {
            oncallNumber = circledMatch[0];
            topStr = topStr.replace(/[‚ë†‚ë°‚ë¢]/g, '');
        }
        
        if (topStr.includes('o/c') || bottomStr.includes('o/c')) {
            isOncall = true;
            topStr = topStr.replace(/o\/c/gi, '');
            bottomStr = bottomStr.replace(/o\/c/gi, '');
        }
        
        topStr = topStr.replace(/i\/c/gi, '');
        bottomStr = bottomStr.replace(/i\/c/gi, '');

        // Extract times
        let startTime = null;
        let endTime = null;

        const startMatch = topStr.match(/(\d{4})/);
        if (startMatch) {
            startTime = startMatch[1];
        }

        const endMatch = bottomStr.match(/(\d{4})/);
        if (endMatch) {
            endTime = endMatch[1];
        }

        if (!startTime || !endTime) return null;

        const startDate = new Date(date);
        const endDate = new Date(date);

        startDate.setHours(parseInt(startTime.substr(0, 2)), parseInt(startTime.substr(2, 2)), 0, 0);
        endDate.setHours(parseInt(endTime.substr(0, 2)), parseInt(endTime.substr(2, 2)), 0, 0);

        if (endDate <= startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }

        let title = `${firstName}'s Shift: ${startTime}-${endTime}`;
        if (isOncall || oncallNumber) {
            title += ` o/c${oncallNumber}`;
        }

        return {
            title: title,
            start: startDate,
            end: endDate
        };
    }

    function createICSContent(events, fullName) {
        const now = new Date();
        const timestamp = formatDateICS(now);
        
        let lines = [];
        lines.push('BEGIN:VCALENDAR');
        lines.push('VERSION:2.0');
        lines.push('PRODID:-//Roster Importer//EN');
        lines.push('CALSCALE:GREGORIAN');
        lines.push('METHOD:PUBLISH');
        lines.push(`X-WR-CALNAME:${fullName} Work Roster`);
        lines.push('X-WR-TIMEZONE:Australia/Brisbane');
        
        events.forEach((ev, index) => {
            const uid = `${timestamp}-${index}@roster-importer.com`;
            
            lines.push('BEGIN:VEVENT');
            lines.push(`UID:${uid}`);
            lines.push(`DTSTAMP:${timestamp}`);
            lines.push(`DTSTART:${formatDateICS(ev.start)}`);
            lines.push(`DTEND:${formatDateICS(ev.end)}`);
            lines.push(`SUMMARY:${escapeICS(ev.title)}`);
            lines.push('STATUS:CONFIRMED');
            lines.push('TRANSP:OPAQUE');
            lines.push('SEQUENCE:0');
            lines.push('END:VEVENT');
        });
        
        lines.push('END:VCALENDAR');
        
        return lines.join('\r\n');
    }

    function formatDateICS(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        return date.getUTCFullYear() +
               pad(date.getUTCMonth() + 1) +
               pad(date.getUTCDate()) + 'T' +
               pad(date.getUTCHours()) +
               pad(date.getUTCMinutes()) +
               pad(date.getUTCSeconds()) + 'Z';
    }

    function escapeICS(text) {
        return text.replace(/[\\,;]/g, '\\$&').replace(/\n/g, '\\n');
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = type;
        el.style.display = 'block';
        
        if (type === 'success') {
            setTimeout(() => {
                el.style.display = 'none';
            }, 10000);
        }
    }
</script>

</body>
</html>
