<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roster to Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --error: #FF3B30;
            --success: #34C759;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #666;
        }

        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: white;
        }

        input[type="file"] {
            cursor: pointer;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 10px;
        }

        button:active {
            opacity: 0.7;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background-color: #8E8E93;
        }

        .suggestions {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            position: absolute;
            width: calc(100% - 48px);
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-top: -16px;
        }

        .suggestion-item {
            padding: 14px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 15px;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:active {
            background-color: #e8e8e8;
        }

        #status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-size: 14px;
            line-height: 1.5;
        }

        .error { 
            background-color: #ffe5e5; 
            color: var(--error);
            border: 1px solid var(--error);
        }
        
        .success { 
            background-color: #e5ffe5; 
            color: var(--success);
            border: 1px solid var(--success);
        }

        .hidden { 
            display: none !important; 
        }

        .step-number {
            display: inline-block;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 14px;
            font-weight: bold;
            margin-right: 8px;
        }

        .instructions {
            background: #f9f9f9;
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-top: 16px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
            display: none;
        }

        .instructions.show {
            display: block;
        }

        .instructions ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 4px 0;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìÖ Roster Importer</h1>
    
    <label for="upload"><span class="step-number">1</span>Select Excel File</label>
    <input type="file" id="upload" accept=".xlsx, .xls">

    <div id="search-container" class="hidden">
        <label for="nameInput"><span class="step-number">2</span>Search Your Name</label>
        <div style="position: relative;">
            <input type="text" id="nameInput" placeholder="Start typing your name..." autocomplete="off">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <div class="button-group">
            <button id="generateBtn">üì≤ Share Calendar File</button>
            <button id="emailBtn" class="secondary">üìß Email Instructions</button>
        </div>
        
        <div id="instructions" class="instructions">
            <strong>üì≤ How to Import on iPhone:</strong>
            <ol>
                <li><strong>Using Share:</strong> Tap "Share Calendar File" ‚Üí Save to Files ‚Üí Open the file ‚Üí Tap "Add All"</li>
                <li><strong>Using Email:</strong> Tap "Email Instructions" ‚Üí Send to yourself ‚Üí Open email on iPhone ‚Üí Follow the steps in the email</li>
            </ol>
        </div>
    </div>

    <div id="status"></div>
</div>

<script>
    let rosterData = [];
    let rosterDates = [];
    let staffNames = [];
    let lastGeneratedICS = null;
    let lastGeneratedName = null;

    // File Upload Handler
    document.getElementById('upload').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        showStatus("üìÇ Loading file...", "success");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                processExcelData(rawData);
            } catch (error) {
                showStatus("‚ùå Error reading file. Please ensure it's a valid Excel file.", "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Process Excel Data
    function processExcelData(data) {
        rosterData = data;
        staffNames = [];
        rosterDates = [];

        // Find header row with "SURNAME"
        let headerRowIndex = -1;
        for(let i = 0; i < Math.min(data.length, 10); i++) {
            const row = data[i];
            if (row && row.some(cell => typeof cell === 'string' && cell.toUpperCase().includes('SURNAME'))) {
                headerRowIndex = i;
                break;
            }
        }

        if (headerRowIndex === -1) {
            showStatus("‚ùå Could not find 'SURNAME' column. Please check your file format.", "error");
            return;
        }

        // Extract dates from the row above header
        const dateRow = data[headerRowIndex - 1] || data[headerRowIndex];
        dateRow.forEach((cell, index) => {
            if (index > 0) {
                if (cell instanceof Date) {
                    rosterDates.push({ index: index, date: cell });
                } else if (typeof cell === 'string' && !isNaN(Date.parse(cell))) {
                    rosterDates.push({ index: index, date: new Date(cell) });
                } else if (typeof cell === 'number') {
                    const date = new Date((cell - 25569) * 86400 * 1000);
                    if (date.getFullYear() > 2000 && date.getFullYear() < 2100) {
                        rosterDates.push({ index: index, date: date });
                    }
                }
            }
        });

        // Extract staff names
        for (let i = headerRowIndex + 1; i < data.length; i++) {
            const row = data[i];
            if (row[0] && typeof row[0] === 'string' && row[0].trim()) {
                const name = row[0].trim();
                if (!name.toUpperCase().includes('TOTAL') && 
                    !name.toUpperCase().includes('SURNAME') &&
                    name.length > 2) {
                    staffNames.push(name);
                }
            }
        }

        if (staffNames.length > 0 && rosterDates.length > 0) {
            document.getElementById('search-container').classList.remove('hidden');
            showStatus(`‚úÖ Loaded ${staffNames.length} staff members and ${rosterDates.length} dates.`, "success");
            document.getElementById('nameInput').focus();
        } else if (staffNames.length === 0) {
            showStatus("‚ùå No staff names found. Check that names are in the first column.", "error");
        } else {
            showStatus("‚ùå No dates found. Check that dates are in the header row.", "error");
        }
    }

    // Autocomplete
    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');

    nameInput.addEventListener('input', function() {
        const input = this.value.toLowerCase().trim();
        suggestionsBox.innerHTML = '';
        
        if (input.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const searchParts = input.split(/[\s,]+/).filter(p => p.length > 0);
        
        const matches = staffNames.filter(name => {
            const lowerName = name.toLowerCase();
            return searchParts.every(part => lowerName.includes(part));
        }).slice(0, 10);

        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = match;
                div.addEventListener('click', function() {
                    nameInput.value = match;
                    suggestionsBox.style.display = 'none';
                });
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target !== nameInput) {
            suggestionsBox.style.display = 'none';
        }
    });

    // Generate Calendar - Main Button
    document.getElementById('generateBtn').addEventListener('click', function() {
        const icsContent = generateCalendar();
        if (!icsContent) return;

        // Try Web Share API first (best for iOS)
        if (navigator.share && navigator.canShare) {
            try {
                const file = new File(
                    [icsContent], 
                    `${lastGeneratedName.replace(/[^a-z0-9]/gi, '_')}_Roster.ics`, 
                    { type: 'text/calendar' }
                );

                if (navigator.canShare({ files: [file] })) {
                    navigator.share({
                        title: `${lastGeneratedName} Roster`,
                        text: 'Work roster calendar',
                        files: [file]
                    }).then(() => {
                        document.getElementById('instructions').classList.add('show');
                        showStatus("‚úÖ Calendar shared! Save to Files, then tap to open in Calendar app.", "success");
                    }).catch((err) => {
                        if (err.name !== 'AbortError') {
                            downloadFallback(icsContent, lastGeneratedName);
                        }
                    });
                    return;
                }
            } catch (err) {
                console.log('Share API failed:', err);
            }
        }

        // Fallback to download
        downloadFallback(icsContent, lastGeneratedName);
    });

    // Email Button
    document.getElementById('emailBtn').addEventListener('click', function() {
        const icsContent = generateCalendar();
        if (!icsContent) return;

        const subject = encodeURIComponent(`${lastGeneratedName} Work Roster`);
        const body = encodeURIComponent(
`Hi,

Your work roster calendar file is ready!

TO IMPORT ON iPHONE:
1. Open this email on your iPhone
2. Scroll down to see the calendar data below
3. Tap and hold on the calendar data
4. Select "Copy"
5. Open Notes app and paste
6. Tap the pasted text
7. Your iPhone will offer to create calendar events
8. Tap "Add All"

CALENDAR DATA (Copy everything below this line):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${icsContent}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Alternatively, you can save this as a file named "roster.ics" and open it on your iPhone.

`);
        
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
        document.getElementById('instructions').classList.add('show');
        showStatus("üìß Email opened! Send it to yourself and follow the instructions.", "success");
    });

    function generateCalendar() {
        const selectedName = nameInput.value.trim();
        
        if (!selectedName) {
            showStatus("‚ö†Ô∏è Please enter a name.", "error");
            return null;
        }

        let targetRow = rosterData.find(row => row[0] === selectedName);

        if (!targetRow) {
            const lowerSelected = selectedName.toLowerCase();
            targetRow = rosterData.find(row => 
                row[0] && typeof row[0] === 'string' && 
                row[0].toLowerCase() === lowerSelected
            );
        }

        if (!targetRow) {
            const similar = staffNames.filter(name => 
                name.toLowerCase().includes(selectedName.toLowerCase())
            ).slice(0, 3);
            
            let errorMsg = `‚ùå Could not find "${selectedName}".`;
            if (similar.length > 0) {
                errorMsg += `\n\nDid you mean:\n‚Ä¢ ${similar.join('\n‚Ä¢ ')}`;
            }
            showStatus(errorMsg, "error");
            return null;
        }

        let events = [];
        rosterDates.forEach(dateObj => {
            const colIndex = dateObj.index;
            const shiftContent = targetRow[colIndex];

            if (shiftContent && typeof shiftContent === 'string') {
                const shiftInfo = parseShift(shiftContent, dateObj.date);
                if (shiftInfo) {
                    events.push(shiftInfo);
                }
            }
        });

        if (events.length === 0) {
            showStatus("‚ùå No shifts found for this person.", "error");
            return null;
        }

        lastGeneratedName = selectedName;
        lastGeneratedICS = createICSContent(events, selectedName);
        return lastGeneratedICS;
    }

    function parseShift(cellText, date) {
        const cleaned = cellText.trim().toUpperCase();
        
        // Skip non-work days
        if (!cleaned || cleaned === 'X' || cleaned === 'RDO' || 
            cleaned.includes('SECONDMENT') || cleaned.includes('LWOP')) {
            return null;
        }

        // Check for time range (e.g., "0800-1630")
        const timeMatch = cellText.match(/(\d{4})-(\d{4})/);
        
        let title = `Shift: ${cellText}`;
        let startDate = new Date(date);
        let endDate = new Date(date);

        if (timeMatch) {
            const startStr = timeMatch[1];
            const endStr = timeMatch[2];

            startDate.setHours(parseInt(startStr.substr(0,2)), parseInt(startStr.substr(2,2)), 0, 0);
            endDate.setHours(parseInt(endStr.substr(0,2)), parseInt(endStr.substr(2,2)), 0, 0);

            if (endDate <= startDate) {
                endDate.setDate(endDate.getDate() + 1);
            }
        } else {
            // All-day event for codes like "A/L", "C", "ML"
            startDate.setHours(9, 0, 0, 0);
            endDate.setHours(17, 0, 0, 0);
        }

        return {
            title: title,
            start: startDate,
            end: endDate
        };
    }

    // Create iOS-compatible ICS content
    function createICSContent(events, name) {
        const now = new Date();
        const timestamp = formatDateICS(now);
        
        // Use CRLF line endings (required by iCalendar spec)
        let lines = [];
        lines.push('BEGIN:VCALENDAR');
        lines.push('VERSION:2.0');
        lines.push('PRODID:-//Roster Importer//EN');
        lines.push('CALSCALE:GREGORIAN');
        lines.push('METHOD:PUBLISH');
        lines.push(`X-WR-CALNAME:${name} Work Roster`);
        lines.push('X-WR-TIMEZONE:Australia/Brisbane');
        
        events.forEach((ev, index) => {
            const uid = `${timestamp}-${index}@roster-importer`;
            
            lines.push('BEGIN:VEVENT');
            lines.push(`UID:${uid}`);
            lines.push(`DTSTAMP:${timestamp}`);
            lines.push(`DTSTART:${formatDateICS(ev.start)}`);
            lines.push(`DTEND:${formatDateICS(ev.end)}`);
            lines.push(`SUMMARY:${escapeICS(ev.title)}`);
            lines.push('STATUS:CONFIRMED');
            lines.push('TRANSP:OPAQUE');
            lines.push('END:VEVENT');
        });
        
        lines.push('END:VCALENDAR');
        
        // Join with CRLF as per RFC 5545
        return lines.join('\r\n');
    }

    function formatDateICS(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        return date.getUTCFullYear() +
               pad(date.getUTCMonth() + 1) +
               pad(date.getUTCDate()) + 'T' +
               pad(date.getUTCHours()) +
               pad(date.getUTCMinutes()) +
               pad(date.getUTCSeconds()) + 'Z';
    }

    function escapeICS(text) {
        return text.replace(/[\\,;]/g, '\\$&').replace(/\n/g, '\\n');
    }

    function downloadFallback(icsContent, name) {
        try {
            const blob = new Blob([icsContent], { 
                type: 'text/calendar;charset=utf-8' 
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/[^a-z0-9]/gi, '_')}_Roster.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            document.getElementById('instructions').classList.add('show');
            showStatus("‚úÖ Calendar file downloaded! Open it on your iPhone to import.", "success");
        } catch (err) {
            showStatus("‚ùå Download failed. Try the Email option instead.", "error");
        }
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = type;
        el.style.display = 'block';
        
        // Auto-hide success messages after 10 seconds
        if (type === 'success') {
            setTimeout(() => {
                el.style.display = 'none';
            }, 10000);
        }
    }
</script>

</body>
</html>
