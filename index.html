<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roster to Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        :root {
            --primary: #007AFF;
            --primary-dark: #0051D5;
            --secondary: #5856D6;
            --success: #34C759;
            --error: #FF3B30;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #1C1C1E;
            --text-secondary: #8E8E93;
            --border: rgba(0, 0, 0, 0.1);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: var(--shadow);
            padding: 32px 24px;
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .header-icon {
            font-size: 48px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }
        .step-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 14px;
            font-weight: 700;
            margin-right: 8px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }
        input[type="file"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        input[type="file"]:hover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.05);
        }
        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        .suggestions {
            border: 2px solid var(--border);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
        }
        .suggestion-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 15px;
            transition: background 0.2s ease;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:active {
            background: rgba(0, 122, 255, 0.1);
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }
        button {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        button:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .btn-secondary:hover {
            background: rgba(0, 122, 255, 0.05);
        }
        #status {
            margin-top: 20px;
            padding: 14px 16px;
            border-radius: 12px;
            text-align: center;
            display: none;
            font-size: 14px;
            line-height: 1.6;
            animation: slideUp 0.3s ease-out;
        }
        .error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--error);
            border: 2px solid var(--error);
        }
        .success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }
        .hidden {
            display: none !important;
        }
        .instructions {
            background: linear-gradient(135deg, rgba(88, 86, 214, 0.1), rgba(102, 126, 234, 0.1));
            border-left: 4px solid var(--secondary);
            padding: 16px;
            margin-top: 20px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.8;
            display: none;
        }
        .instructions.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        .instructions strong {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--secondary);
        }
        .instructions ol {
            margin: 8px 0 0 20px;
        }
        .instructions li {
            margin: 6px 0;
        }
        .search-wrapper {
            position: relative;
        }
        @media (max-width: 480px) {
            .container {
                padding: 24px 20px;
            }
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-icon">üìÖ</div>
        <h1>Roster Importer</h1>
        <p class="subtitle">Convert your roster to iPhone calendar</p>
    </div>
    <div class="form-group">
        <label><span class="step-badge">1</span>Upload Excel File</label>
        <input type="file" id="upload" accept=".xlsx, .xls">
    </div>
    <div id="search-container" class="hidden">
        <div class="form-group">
            <label><span class="step-badge">2</span>Search Your Name</label>
            <div class="search-wrapper">
                <input type="text" id="nameInput" placeholder="e.g., Megan Falkenhagen" autocomplete="off">
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>
        <div class="button-group">
            <button id="downloadBtn" class="btn-primary">
                üì• Download Calendar File
            </button>
            <button id="shareBtn" class="btn-secondary">
                üì§ Share/Email File
            </button>
        </div>
        <div id="instructions" class="instructions">
            <strong>üì≤ To Import on iPhone:</strong>
            <ol>
                <li><strong>Download method:</strong> Tap "Download", save to Files app, then open the .ics file from Files</li>
                <li><strong>Share method:</strong> Tap "Share/Email", choose Mail, send to yourself, then open the email and tap the attachment</li>
                <li>iOS will show "Add All" - tap it to import shifts to your Calendar</li>
            </ol>
        </div>
    </div>
    <div id="status"></div>
</div>
<script>
    let rosterData = [];
    let staffList = []; // Array of {fullName, firstName, rowIndex}
    let shiftDates = []; // Array of {colIndex, date}
    let lastGeneratedICS = null;
    let lastGeneratedName = null;
    document.getElementById('upload').addEventListener('change', handleFile, false);
    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        showStatus("üìÇ Loading file...", "success");
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                processExcelData(rawData);
            } catch (error) {
                showStatus("‚ùå Error reading file: " + error.message, "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function processExcelData(data) {
        rosterData = data;
        staffList = [];
        shiftDates = [];

        // 1. Find week starting date
        // Context indicates "Change Dates in Cell G5" and date examples like "2/16/2026".
        // We look dynamically in the first 10 rows/cols to find a date object or string.
        let weekStart = null;
        
        for(let r=0; r<10; r++) {
            if(!data[r]) continue;
            for(let c=0; c<10; c++) {
                const val = data[r][c];
                if (val instanceof Date) {
                    weekStart = val;
                    break;
                }
                // Check for string dates like "2/16/2026" or "DATE: 2/16/2026"
                if (typeof val === 'string') {
                     if (val.match(/\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}/)) {
                         // Attempt to parse string
                         const cleanDate = val.replace('DATE:', '').trim();
                         weekStart = new Date(cleanDate);
                         if (!isNaN(weekStart)) break;
                     }
                }
            }
            if(weekStart) break;
        }

        if (!weekStart || isNaN(weekStart)) {
            // Fallback: The context explicitly mentions Cell G5 (Row index 4, Col index 6)
            if (data[4] && data[4][6]) {
                 weekStart = new Date(data[4][6]);
            }
        }

        if (!weekStart || isNaN(weekStart)) {
            showStatus("‚ùå Could not find week starting date (checked Cell G5 and others).", "error");
            return;
        }

        // 2. Find dates in row 7 (index 6)
        // Row 7 contains day numbers: 16, 17... 28, 1, 2. We must handle month rollover.
        const dateRow = data[6]; // Row 7 (0-indexed as 6)
        if (!dateRow) {
             showStatus("‚ùå Could not find date row (Row 7).", "error");
             return;
        }

        let currentMonth = weekStart.getMonth();
        let currentYear = weekStart.getFullYear();
        let prevDayVal = 0;

        for (let colIndex = 4; colIndex < dateRow.length; colIndex++) {
            const cell = dateRow[colIndex];
            
            if (typeof cell === 'number' && cell >= 1 && cell <= 31) {
                // Detect month rollover (e.g., going from 28 to 1)
                if (cell < prevDayVal) {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                }
                
                const date = new Date(currentYear, currentMonth, cell);
                shiftDates.push({ colIndex: colIndex, date: date });
                prevDayVal = cell;
            }
        }

        if (shiftDates.length === 0) {
            showStatus("‚ùå No dates found in row 7. Please check file format.", "error");
            return;
        }

        // 3. Find staff names
        // Context shows names in format "SURNAME, Firstname" in column A
        for (let rowIndex = 7; rowIndex < data.length; rowIndex++) {
            const row = data[rowIndex];
            if (!row) continue;
            const nameCell = row[0]; // Column A

            if (nameCell && typeof nameCell === 'string' && nameCell.includes(',')) {
                const parts = nameCell.split(',');
                if (parts.length >= 2) {
                    const surname = parts[0].trim();
                    const firstname = parts[1].trim().split(/\s+/)[0]; // First word of first name

                    // Filter out headers like "TOTAL Earlies" or "SURNAME"
                    if (!surname.toUpperCase().includes('TOTAL') && 
                        !surname.toUpperCase().includes('SURNAME') && 
                        !surname.toUpperCase().includes('ORG UNIT') &&
                        surname.length > 1 && firstname.length > 0) {
                        
                        staffList.push({
                            fullName: nameCell,
                            firstName: firstname,
                            rowIndex: rowIndex
                        });
                    }
                }
            }
        }

        if (staffList.length > 0) {
            document.getElementById('search-container').classList.remove('hidden');
            showStatus(`‚úÖ Loaded ${staffList.length} staff members and dates starting ${weekStart.toLocaleDateString()}.`, "success");
            document.getElementById('nameInput').focus();
        } else {
            showStatus("‚ùå No staff names found. Check that names are in format 'SURNAME, Firstname'.", "error");
        }
    }

    // Autocomplete
    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');
    nameInput.addEventListener('input', function() {
        const input = this.value.toLowerCase().trim();
        suggestionsBox.innerHTML = '';
        if (input.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }
        const matches = staffList.filter(staff => {
            return staff.fullName.toLowerCase().includes(input) ||
                   staff.firstName.toLowerCase().includes(input);
        }).slice(0, 10);
        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(staff => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = staff.fullName;
                div.addEventListener('click', function() {
                    nameInput.value = staff.fullName;
                    suggestionsBox.style.display = 'none';
                });
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    });
    document.addEventListener('click', function(e) {
        if (e.target !== nameInput) {
            suggestionsBox.style.display = 'none';
        }
    });
    // Download Button
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const result = generateCalendar();
        if (!result) return;
        const blob = new Blob([result.icsContent], { type: 'text/calendar;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${result.firstName}_Roster.ics`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        document.getElementById('instructions').classList.add('show');
        showStatus("‚úÖ Calendar file downloaded! Save to Files, then tap to open in Calendar.", "success");
    });
    // Share/Email Button (uses Web Share API)
    document.getElementById('shareBtn').addEventListener('click', function() {
        const result = generateCalendar();
        if (!result) return;
        const file = new File(
            [result.icsContent],
            `${result.firstName}_Roster.ics`,
            { type: 'text/calendar' }
        );
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                title: `${result.firstName}'s Work Roster`,
                text: `Roster calendar for ${result.fullName}`,
                files: [file]
            }).then(() => {
                document.getElementById('instructions').classList.add('show');
                showStatus("‚úÖ File shared! Choose Mail to email it to yourself.", "success");
            }).catch((err) => {
                if (err.name !== 'AbortError') {
                    showStatus("‚ùå Share failed. Try the Download button instead.", "error");
                }
            });
        } else {
            // Fallback: Download
            const blob = new Blob([result.icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${result.firstName}_Roster.ics`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showStatus("‚úÖ File downloaded (Share not supported on this browser).", "success");
        }
    });
    function generateCalendar() {
        const selectedName = nameInput.value.trim();
        if (!selectedName) {
            showStatus("‚ö†Ô∏è Please enter a name.", "error");
            return null;
        }
        const staff = staffList.find(s =>
            s.fullName.toLowerCase() === selectedName.toLowerCase()
        );
        if (!staff) {
            const similar = staffList.filter(s =>
                s.fullName.toLowerCase().includes(selectedName.toLowerCase())
            ).slice(0, 3);
            let errorMsg = `‚ùå Could not find "${selectedName}".`;
            if (similar.length > 0) {
                errorMsg += `\n\nDid you mean:\n‚Ä¢ ${similar.map(s => s.fullName).join('\n‚Ä¢ ')}`;
            }
            showStatus(errorMsg, "error");
            return null;
        }
        // Parse shifts for this person
        // Shifts are split across current row and next row
        const topRow = rosterData[staff.rowIndex]; // Row with start times
        const bottomRow = rosterData[staff.rowIndex + 1]; // Row with end times
        let events = [];
        shiftDates.forEach(dateInfo => {
            const colIndex = dateInfo.colIndex;
            const date = dateInfo.date;
            const topCell = topRow ? topRow[colIndex] : null;
            const bottomCell = bottomRow ? bottomRow[colIndex] : null;
            const shiftInfo = parseShift(topCell, bottomCell, date, staff.firstName);
            if (shiftInfo) {
                events.push(shiftInfo);
            }
        });
        if (events.length === 0) {
            showStatus("‚ùå No shifts found for this person.", "error");
            return null;
        }
        return {
            icsContent: createICSContent(events, staff.fullName),
            firstName: staff.firstName,
            fullName: staff.fullName
        };
    }

    function parseShift(topCell, bottomCell, date, firstName) {
        if (!topCell && !bottomCell) return null;
        
        let topStr = typeof topCell === 'string' ? topCell.trim() : (topCell ? String(topCell) : '');
        let bottomStr = typeof bottomCell === 'string' ? bottomCell.trim() : (bottomCell ? String(bottomCell) : '');
        
        // Clean strings for logic checking
        const clean = (str) => str.toUpperCase().replace(/\s/g, '');
        const topClean = clean(topStr);
        
        // Skip non-work indicators from context (X, RDO, A/L, ML, LWOP, SECONDMENT)
        const skipKeywords = ['X', 'RDO', 'SECONDMENT', 'LWOP', 'A/L', 'ML', 'C'];
        
        // If top cell is explicitly a skip keyword, return null
        if (skipKeywords.includes(topClean)) return null;
        
        // If top is empty, check if bottom has time. If top is empty and bottom is not a time, skip.
        if (topClean === '' && !bottomStr.match(/\d{4}/)) return null;

        // Extract circled number and o/c notation
        let oncallNumber = '';
        let isOncall = false;
        
        // Handle Circled numbers (‚ë†, ‚ë°, ‚ë¢)
        const circledMatch = topStr.match(/[‚ë†‚ë°‚ë¢]/) || bottomStr.match(/[‚ë†‚ë°‚ë¢]/);
        if (circledMatch) {
            oncallNumber = circledMatch[0];
            // Remove from strings so they don't interfere with time parsing
            topStr = topStr.replace(/[‚ë†‚ë°‚ë¢]/g, ''); 
        }
        
        // Handle o/c (On Call)
        if (topStr.toLowerCase().includes('o/c') || bottomStr.toLowerCase().includes('o/c')) {
            isOncall = true;
        }

        // Handle i/c (In Charge - optional, just remove text to find time)
        topStr = topStr.replace(/i\/c/gi, '');
        bottomStr = bottomStr.replace(/i\/c/gi, '');

        let startTime = null;
        let endTime = null;

        // SCENARIO 1: Combined format "0830-1700" in top cell (found in context)
        // Look for 4 digits, separator, 4 digits
        const combinedMatch = topStr.match(/(\d{4})\s*-\s*(\d{4})/);
        
        if (combinedMatch) {
            startTime = combinedMatch[1];
            endTime = combinedMatch[2];
        } else {
            // SCENARIO 2: Split format "0800-" (top) and "1700" (bottom)
            const startMatch = topStr.match(/(\d{4})/);
            const endMatch = bottomStr.match(/(\d{4})/);
            
            if (startMatch) startTime = startMatch[1];
            if (endMatch) endTime = endMatch[1];
        }

        if (!startTime || !endTime) return null;

        // Create Dates
        const startDate = new Date(date);
        const endDate = new Date(date);
        
        startDate.setHours(parseInt(startTime.substr(0, 2)), parseInt(startTime.substr(2, 2)), 0, 0);
        endDate.setHours(parseInt(endTime.substr(0, 2)), parseInt(endTime.substr(2, 2)), 0, 0);

        // Handle overnight shifts (end time is smaller than start time)
        if (endDate <= startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }

        // Build title
        let title = `${firstName} Shift: ${startTime}-${endTime}`;
        if (isOncall || oncallNumber) {
            title += ` o/c${oncallNumber}`;
        }

        return {
            title: title,
            start: startDate,
            end: endDate
        };
    }

    function createICSContent(events, fullName) {
        const now = new Date();
        const timestamp = formatDateICS(now);
        let lines = [];
        lines.push('BEGIN:VCALENDAR');
        lines.push('VERSION:2.0');
        lines.push('PRODID:-//Roster Importer//EN');
        lines.push('CALSCALE:GREGORIAN');
        lines.push('METHOD:PUBLISH');
        lines.push(`X-WR-CALNAME:${fullName} Work Roster`);
        lines.push('X-WR-TIMEZONE:Australia/Brisbane');
        events.forEach((ev, index) => {
            const uid = `${timestamp}-${index}@roster-importer.com`;
            lines.push('BEGIN:VEVENT');
            lines.push(`UID:${uid}`);
            lines.push(`DTSTAMP:${timestamp}`);
            lines.push(`DTSTART:${formatDateICS(ev.start)}`);
            lines.push(`DTEND:${formatDateICS(ev.end)}`);
            lines.push(`SUMMARY:${escapeICS(ev.title)}`);
            lines.push('STATUS:CONFIRMED');
            lines.push('TRANSP:OPAQUE');
            lines.push('SEQUENCE:0');
            lines.push('END:VEVENT');
        });
        lines.push('END:VCALENDAR');
        return lines.join('\r\n');
    }
    function formatDateICS(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        return date.getUTCFullYear() +
               pad(date.getUTCMonth() + 1) +
               pad(date.getUTCDate()) + 'T' +
               pad(date.getUTCHours()) +
               pad(date.getUTCMinutes()) +
               pad(date.getUTCSeconds()) + 'Z';
    }
    function escapeICS(text) {
        return text.replace(/[\\,;]/g, '\\$&').replace(/\n/g, '\\n');
    }
    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = type;
        el.style.display = 'block';
        if (type === 'success') {
            setTimeout(() => {
                el.style.display = 'none';
            }, 10000);
        }
    }
</script>
</body>
</html>
