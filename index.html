<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roster to Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --error: #FF3B30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #666;
        }

        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            width: 100%;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:active {
            opacity: 0.8;
        }

        .suggestions {
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            background: white;
            position: absolute;
            width: calc(100% - 48px);
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .error { background-color: #ffe5e5; color: var(--error); }
        .success { background-color: #e5ffe5; color: #34C759; }

        .hidden { display: none; }

        .instructions {
            background: #f0f8ff;
            border-left: 4px solid var(--primary);
            padding: 12px;
            margin-top: 16px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
            display: none;
        }

        .instructions.show {
            display: block;
        }

        .instructions ol {
            margin: 8px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Roster Importer</h1>
    
    <label for="upload">1. Select Excel File</label>
    <input type="file" id="upload" accept=".xlsx, .xls">

    <div id="search-container" class="hidden">
        <label for="nameInput">2. Search Name</label>
        <div style="position: relative;">
            <input type="text" id="nameInput" placeholder="e.g., Angela Thomson" autocomplete="off">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <button id="generateBtn">ðŸ“§ Email Calendar to Myself</button>

        <div id="instructions" class="instructions">
            <strong>ðŸ“² How to Import on iPhone:</strong>
            <ol>
                <li>Tap the button above to open Mail</li>
                <li>Send the email to yourself</li>
                <li>Open the email on your iPhone</li>
                <li>Scroll down and tap on the calendar data</li>
                <li>Your iPhone will recognize it and show "Add All"</li>
                <li>Tap "Add All" to import to your Calendar</li>
            </ol>
        </div>
    </div>

    <div id="status"></div>
</div>

<script>
    let rosterData = [];
    let rosterDates = [];
    let staffNames = [];

    // 1. Listen for File Upload
    document.getElementById('upload').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            processExcelData(rawData);
        };
        reader.readAsArrayBuffer(file);
    }

    // 2. Process Excel Structure
    function processExcelData(data) {
        rosterData = data;
        staffNames = [];
        rosterDates = [];

        // Find the header row containing "SURNAME"
        let headerRowIndex = -1;
        
        for(let i=0; i<data.length; i++) {
            const row = data[i];
            if (row.some(cell => typeof cell === 'string' && cell.toUpperCase().includes('SURNAME'))) {
                headerRowIndex = i;
                break;
            }
        }

        if (headerRowIndex === -1) {
            showStatus("Error: Could not find 'SURNAME' header in spreadsheet.", "error");
            return;
        }

        // Extract Dates from the same header row (numbers like 16, 17, 18...)
        const headerRow = data[headerRowIndex];
        
        headerRow.forEach((cell, index) => {
            // Look for day numbers (1-31) in columns after the first few
            if (index > 3 && typeof cell === 'number' && cell >= 1 && cell <= 31) {
                // Create a date - we'll need to figure out the month/year from context
                // For now, use current year and month as placeholder
                const today = new Date();
                const date = new Date(today.getFullYear(), today.getMonth(), cell);
                rosterDates.push({ index: index, date: date });
            } else if (index > 3 && cell instanceof Date) {
                rosterDates.push({ index: index, date: cell });
            }
        });

        // Extract Names (Column 0)
        for (let i = headerRowIndex + 1; i < data.length; i++) {
            const row = data[i];
            if (row[0] && typeof row[0] === 'string' && row[0].trim().length > 0) {
                const name = row[0].trim();
                // Skip totals and other non-name rows
                if (!name.toUpperCase().includes('TOTAL') && !name.toUpperCase().includes('CASUAL')) {
                    staffNames.push(name);
                }
            }
        }

        // UI Updates
        if (staffNames.length > 0 && rosterDates.length > 0) {
            document.getElementById('search-container').classList.remove('hidden');
            showStatus(`Loaded ${staffNames.length} staff members and ${rosterDates.length} days.`, "success");
        } else if (staffNames.length === 0) {
            showStatus("File loaded, but no names found in Column A.", "error");
        } else {
            showStatus("No dates found. Check that dates are in the header row.", "error");
        }
    }

    // 3. Autocomplete & Search Logic
    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');

    nameInput.addEventListener('keyup', function() {
        const input = this.value.toLowerCase();
        suggestionsBox.innerHTML = '';
        
        if (input.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }

        const searchParts = input.split(/[\s,]+/);

        const matches = staffNames.filter(name => {
            const lowerName = name.toLowerCase();
            return searchParts.every(part => lowerName.includes(part));
        });

        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = match;
                div.onclick = function() {
                    nameInput.value = match;
                    suggestionsBox.style.display = 'none';
                };
                suggestionsBox.appendChild(div);
            });
        } else {
            suggestionsBox.style.display = 'none';
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target !== nameInput) {
            suggestionsBox.style.display = 'none';
        }
    });

    // 4. Generate Calendar Logic
    document.getElementById('generateBtn').addEventListener('click', function() {
        const selectedName = nameInput.value;
        if (!selectedName) {
            showStatus("Please enter a name.", "error");
            return;
        }

        // Find the row for this person
        const targetRow = rosterData.find(row => row[0] === selectedName);

        if (!targetRow) {
            showStatus(`Could not find "${selectedName}". Please select a name from the list.`, "error");
            return;
        }

        let events = [];
        
        // Loop through the columns where we found dates
        rosterDates.forEach(dateObj => {
            const colIndex = dateObj.index;
            const shiftContent = targetRow[colIndex];

            if (shiftContent && typeof shiftContent === 'string') {
                const shiftInfo = parseShift(shiftContent, dateObj.date);
                if (shiftInfo) {
                    events.push(shiftInfo);
                }
            }
        });

        if (events.length === 0) {
            showStatus("No shifts found for this user.", "error");
            return;
        }

        emailICS(events, selectedName);
    });

    function parseShift(cellText, date) {
        // Ignore "X" (Day off) or empty
        if (!cellText || cellText.trim().toUpperCase() === 'X') return null;

        // Check for times: Pattern 4 digits - 4 digits (e.g. 0800-1630)
        const timeMatch = cellText.match(/(\d{4})-(\d{4})/);
        
        let title = `Shift: ${cellText}`;
        let startDate = new Date(date);
        let endDate = new Date(date);

        if (timeMatch) {
            const startStr = timeMatch[1];
            const endStr = timeMatch[2];

            startDate.setHours(parseInt(startStr.substr(0,2)), parseInt(startStr.substr(2,2)), 0);
            endDate.setHours(parseInt(endStr.substr(0,2)), parseInt(endStr.substr(2,2)), 0);

            // Handle overnight shifts
            if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1);
            }
        } else {
            // All day event for things like "A/L", "C", etc.
            startDate.setHours(8, 0, 0);
            endDate.setHours(17, 0, 0);
        }

        return {
            title: title,
            start: startDate,
            end: endDate
        };
    }

    // 5. Email ICS File (iOS-Compatible)
    function emailICS(events, name) {
        // Create iOS-compatible ICS content
        const now = new Date();
        const timestamp = formatDateICS(now);
        
        let icsLines = [];
        icsLines.push('BEGIN:VCALENDAR');
        icsLines.push('VERSION:2.0');
        icsLines.push('PRODID:-//Roster Importer//EN');
        icsLines.push('CALSCALE:GREGORIAN');
        icsLines.push('METHOD:PUBLISH');
        icsLines.push(`X-WR-CALNAME:${name} Work Roster`);
        
        events.forEach((ev, index) => {
            const uid = `${timestamp}-${index}@roster`;
            
            icsLines.push('BEGIN:VEVENT');
            icsLines.push(`UID:${uid}`);
            icsLines.push(`DTSTAMP:${timestamp}`);
            icsLines.push(`DTSTART:${formatDateICS(ev.start)}`);
            icsLines.push(`DTEND:${formatDateICS(ev.end)}`);
            icsLines.push(`SUMMARY:${escapeICS(ev.title)}`);
            icsLines.push('STATUS:CONFIRMED');
            icsLines.push('END:VEVENT');
        });
        
        icsLines.push('END:VCALENDAR');
        
        const icsContent = icsLines.join('\r\n');

        // Create mailto link
        const subject = encodeURIComponent(`${name} Work Roster`);
        const body = encodeURIComponent(
`Hi,

Your work roster calendar is ready to import!

TO ADD TO iPHONE CALENDAR:
1. Open this email on your iPhone
2. Scroll down to the calendar data below
3. Tap and HOLD on the calendar data
4. Select "Copy"
5. Open the Notes app
6. Paste the calendar data
7. Tap on the pasted text
8. iOS will recognize it and show "Add to Calendar"
9. Tap "Add All"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CALENDAR DATA (copy everything below):

${icsContent}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Found ${events.length} shifts for ${name}.
`);
        
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
        
        document.getElementById('instructions').classList.add('show');
        showStatus("ðŸ“§ Email opened! Send it to yourself, then follow the instructions to import on iPhone.", "success");
    }

    function formatDateICS(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        return date.getUTCFullYear() +
               pad(date.getUTCMonth() + 1) +
               pad(date.getUTCDate()) + 'T' +
               pad(date.getUTCHours()) +
               pad(date.getUTCMinutes()) +
               pad(date.getUTCSeconds()) + 'Z';
    }

    function escapeICS(text) {
        return text.replace(/[\\,;]/g, '\\$&').replace(/\n/g, '\\n');
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = type;
        el.style.display = 'block';
    }
</script>

</body>
</html>
