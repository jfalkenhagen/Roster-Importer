<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roster to Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #007AFF; --primary-dark: #0051D5; --secondary: #5856D6;
            --success: #34C759; --error: #FF3B30; --text: #1C1C1E; --text-secondary: #8E8E93;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95); --border: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient); color: var(--text); min-height: 100vh;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .container {
            background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); padding: 32px 24px; width: 100%; max-width: 420px;
        }
        .header { text-align: center; margin-bottom: 32px; }
        .header-icon { font-size: 48px; margin-bottom: 12px; }
        h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--text-secondary); font-size: 15px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; font-size: 15px; font-weight: 600; margin-bottom: 10px; }
        .step-badge {
            display: inline-block; background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; width: 28px; height: 28px; border-radius: 50%; text-align: center;
            line-height: 28px; font-size: 14px; font-weight: 700; margin-right: 8px;
        }
        input[type="file"] {
            width: 100%; padding: 14px 16px; border: 2px dashed var(--border);
            border-radius: 12px; background: white; cursor: pointer;
        }
        input[type="text"] {
            width: 100%; padding: 14px 16px; border: 2px solid var(--border);
            border-radius: 12px; font-size: 16px; background: white;
        }
        .suggestions {
            border: 2px solid var(--border); border-radius: 12px; max-height: 200px;
            overflow-y: auto; background: white; position: absolute; width: 100%; z-index: 1000;
            display: none; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); margin-top: 4px;
        }
        .suggestion-item { padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .suggestion-item:last-child { border-bottom: none; }
        .button-group { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
        button {
            width: 100%; padding: 16px 24px; border: none; border-radius: 12px;
            font-size: 17px; font-weight: 600; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        #status { margin-top: 20px; padding: 14px 16px; border-radius: 12px; text-align: center; display: none; }
        .error { background: rgba(255, 59, 48, 0.1); color: var(--error); border: 2px solid var(--error); }
        .success { background: rgba(52, 199, 89, 0.1); color: var(--success); border: 2px solid var(--success); }
        .hidden { display: none !important; }
        .instructions {
            background: rgba(88, 86, 214, 0.1); border-left: 4px solid var(--secondary);
            padding: 16px; margin-top: 20px; border-radius: 12px; font-size: 13px; line-height: 1.8; display: none;
        }
        .instructions.show { display: block; }
        .search-wrapper { position: relative; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-icon">üìÖ</div>
        <h1>Roster Importer</h1>
        <p class="subtitle">Convert your roster to iPhone calendar</p>
    </div>
    <div class="form-group">
        <label><span class="step-badge">1</span>Upload Excel File</label>
        <input type="file" id="upload" accept=".xlsx, .xls">
    </div>
    <div id="search-container" class="hidden">
        <div class="form-group">
            <label><span class="step-badge">2</span>Search Your Name</label>
            <div class="search-wrapper">
                <!-- UPDATED PLACEHOLDER HERE -->
                <input type="text" id="nameInput" placeholder="e.g., Megan" autocomplete="off">
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>
        <div class="button-group">
            <button id="downloadBtn" class="btn-primary">üì• Download Calendar File</button>
            <button id="shareBtn" class="btn-secondary">üì§ Share/Email File</button>
        </div>
        <div id="instructions" class="instructions">
            <strong>üì≤ To Import on iPhone:</strong>
            <ol>
                <li>Tap "Download", save to Files, then tap the .ics file.</li>
                <li>Or tap "Share", email to yourself, and tap the attachment.</li>
                <li>Tap "Add All" to import events.</li>
            </ol>
        </div>
    </div>
    <div id="status"></div>
</div>
<script>
    let rosterData = [];
    let staffList = [];
    let shiftDates = [];
    
    document.getElementById('upload').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        showStatus("üìÇ Loading file...", "success");
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                processExcelData(rawData);
            } catch (error) {
                showStatus("‚ùå Error: " + error.message, "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function processExcelData(data) {
        rosterData = data;
        staffList = [];
        shiftDates = [];

        // 1. Find week starting date (Dynamic search)
        let weekStart = null;
        for(let r=0; r<10; r++) {
            if(!data[r]) continue;
            for(let c=0; c<10; c++) {
                const val = data[r][c];
                if (val instanceof Date) {
                    weekStart = val; break;
                }
                if (typeof val === 'string' && val.match(/\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}/)) {
                    weekStart = new Date(val.replace('DATE:', '').trim());
                    if (!isNaN(weekStart)) break;
                }
            }
            if(weekStart) break;
        }

        // Fallback to Cell G5 as per context
        if ((!weekStart || isNaN(weekStart)) && data[4] && data[4][6]) {
            weekStart = new Date(data[4][6]);
        }

        if (!weekStart || isNaN(weekStart)) {
            showStatus("‚ùå Could not find week starting date.", "error");
            return;
        }

        // 2. Find dates in row 7 (index 6)
        const dateRow = data[6];
        if (!dateRow) { showStatus("‚ùå Row 7 (Dates) missing.", "error"); return; }

        let currentMonth = weekStart.getMonth();
        let currentYear = weekStart.getFullYear();
        let prevDayVal = 0;

        for (let colIndex = 4; colIndex < dateRow.length; colIndex++) {
            const cell = dateRow[colIndex];
            if (typeof cell === 'number' && cell >= 1 && cell <= 31) {
                // Handle Month Rollover (e.g. 28 -> 1)
                if (cell < prevDayVal) {
                    currentMonth++;
                    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                }
                const date = new Date(currentYear, currentMonth, cell);
                shiftDates.push({ colIndex: colIndex, date: date });
                prevDayVal = cell;
            }
        }

        // 3. Find staff names
        for (let rowIndex = 7; rowIndex < data.length; rowIndex++) {
            const row = data[rowIndex];
            if (!row) continue;
            const nameCell = row[0]; // Column A

            if (nameCell && typeof nameCell === 'string' && nameCell.includes(',')) {
                const parts = nameCell.split(',');
                const surname = parts[0].trim().toUpperCase();
                
                if (!surname.includes('TOTAL') && !surname.includes('SURNAME') && 
                    !surname.includes('ORG UNIT') && parts.length >= 2) {
                    
                    staffList.push({
                        fullName: nameCell,
                        firstName: parts[1].trim().split(/\s+/)[0],
                        rowIndex: rowIndex
                    });
                }
            }
        }

        if (staffList.length > 0) {
            document.getElementById('search-container').classList.remove('hidden');
            showStatus(`‚úÖ Loaded ${staffList.length} staff.`, "success");
        } else {
            showStatus("‚ùå No staff names found.", "error");
        }
    }

    // Autocomplete
    const nameInput = document.getElementById('nameInput');
    const suggestionsBox = document.getElementById('suggestions');
    nameInput.addEventListener('input', function() {
        const input = this.value.toLowerCase().trim();
        suggestionsBox.innerHTML = '';
        if (input.length < 2) { suggestionsBox.style.display = 'none'; return; }
        
        const matches = staffList.filter(s => s.fullName.toLowerCase().includes(input) || s.firstName.toLowerCase().includes(input)).slice(0, 10);
        
        if (matches.length > 0) {
            suggestionsBox.style.display = 'block';
            matches.forEach(staff => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = staff.fullName;
                div.onclick = () => { nameInput.value = staff.fullName; suggestionsBox.style.display = 'none'; };
                suggestionsBox.appendChild(div);
            });
        } else { suggestionsBox.style.display = 'none'; }
    });

    document.getElementById('downloadBtn').addEventListener('click', () => doExport('download'));
    document.getElementById('shareBtn').addEventListener('click', () => doExport('share'));

    function doExport(method) {
        const result = generateCalendar();
        if (!result) return;
        
        const file = new File([result.icsContent], `${result.firstName}_Roster.ics`, { type: 'text/calendar' });

        if (method === 'share' && navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                title: `${result.firstName}'s Roster`,
                files: [file]
            }).catch(err => { if(err.name !== 'AbortError') showStatus("‚ùå Share failed.", "error"); });
        } else {
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            document.getElementById('instructions').classList.add('show');
            showStatus("‚úÖ File downloaded!", "success");
        }
    }

    function generateCalendar() {
        const selectedName = nameInput.value.trim();
        const staff = staffList.find(s => s.fullName.toLowerCase() === selectedName.toLowerCase());
        
        if (!staff) { showStatus("‚ö†Ô∏è Staff not found.", "error"); return null; }

        // Start time is row ABOVE name, End time is row WITH name [1]
        const topRow = rosterData[staff.rowIndex - 1]; // Start times / Position
        const bottomRow = rosterData[staff.rowIndex];  // End times / Name

        let events = [];
        shiftDates.forEach(dateInfo => {
            const col = dateInfo.colIndex;
            const topCell = topRow ? topRow[col] : null;
            const bottomCell = bottomRow ? bottomRow[col] : null;
            
            const event = parseShift(topCell, bottomCell, dateInfo.date, staff.fullName);
            if (event) events.push(event);
        });

        if (events.length === 0) { showStatus("‚ùå No shifts found.", "error"); return null; }

        return {
            icsContent: createICSContent(events, staff.fullName),
            firstName: staff.firstName
        };
    }

    function parseShift(topCell, bottomCell, date, fullName) {
        if (!topCell && !bottomCell) return null;
        
        let topStr = topCell ? String(topCell).trim() : '';
        let bottomStr = bottomCell ? String(bottomCell).trim() : '';
        const topClean = topStr.toUpperCase();
        const bottomClean = bottomStr.toUpperCase();

        // --- STATUS CODE LOGIC [1] ---
        
        // 1. Requested Day Off: Start = R, End = X
        if (topClean === 'R' && bottomClean === 'X') {
            return createAllDayEvent(date, `${fullName} Requested Day Off :)`);
        }
        
        // 2. Day Off: RDO or X
        if (topClean === 'RDO' || topClean === 'X' || bottomClean === 'RDO' || bottomClean === 'X') {
            return createAllDayEvent(date, `${fullName} Day Off :)`);
        }

        // 3. Annual Leave: A/L
        if (topClean.includes('A/L') || bottomClean.includes('A/L')) {
            return createAllDayEvent(date, `${fullName} Annual Leave Day`);
        }

        // 4. Concession Day: C
        if (topClean === 'C' || bottomClean === 'C') {
            return createAllDayEvent(date, `${fullName} Concession Day :)`);
        }

        // 5. Leave Without Pay: LWOP
        if (topClean.includes('LWOP') || bottomClean.includes('LWOP')) {
            return createAllDayEvent(date, `${fullName} Leave Without Pay`);
        }

        // 6. Maternity Leave: ML
        if (topClean.includes('ML') || bottomClean.includes('ML')) {
            return createAllDayEvent(date, `${fullName} Mat Leave`);
        }

        // --- TIME PARSING LOGIC ---
        
        // Handle Circled numbers and o/c
        let oncallNumber = '';
        let isOncall = false;
        
        const circledMatch = topStr.match(/[‚ë†‚ë°‚ë¢]/) || bottomStr.match(/[‚ë†‚ë°‚ë¢]/);
        if (circledMatch) {
            oncallNumber = circledMatch[0];
            topStr = topStr.replace(/[‚ë†‚ë°‚ë¢]/g, ''); 
        }
        if (topClean.includes('O/C') || bottomClean.includes('O/C')) isOncall = true;

        // Clean text to find times
        topStr = topStr.replace(/[a-zA-Z\/]/g, '').trim(); 
        bottomStr = bottomStr.replace(/[a-zA-Z\/]/g, '').trim();

        let startTime = null;
        let endTime = null;

        // Scenario A: Combined "0830-1700" in Top Row
        const combinedMatch = topStr.match(/(\d{4})[\s-]*(\d{4})/);
        if (combinedMatch) {
            startTime = combinedMatch[1];
            endTime = combinedMatch[2];
        } else {
            // Scenario B: Top=Start, Bottom=End
            const sMatch = topStr.match(/(\d{4})/);
            const eMatch = bottomStr.match(/(\d{4})/);
            if (sMatch) startTime = sMatch[1];
            if (eMatch) endTime = eMatch[1];
        }

        if (!startTime || !endTime) return null;

        const startDt = new Date(date);
        startDt.setHours(parseInt(startTime.substring(0,2)), parseInt(startTime.substring(2,4)), 0, 0);
        
        const endDt = new Date(date);
        endDt.setHours(parseInt(endTime.substring(0,2)), parseInt(endTime.substring(2,4)), 0, 0);

        if (endDt <= startDt) endDt.setDate(endDt.getDate() + 1);

        let title = `${fullName} Shift: ${startTime}-${endTime}`;
        if (isOncall || oncallNumber) title += ` o/c${oncallNumber}`;

        return {
            title: title,
            start: startDt,
            end: endDt,
            isAllDay: false
        };
    }

    function createAllDayEvent(date, title) {
        return {
            title: title,
            start: date, // Only date matters
            isAllDay: true
        };
    }

    function createICSContent(events, fullName) {
        const now = new Date();
        const timestamp = formatDateICS(now);
        let lines = [
            'BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//Roster Importer//EN',
            'CALSCALE:GREGORIAN', 'METHOD:PUBLISH', `X-WR-CALNAME:${fullName} Roster`
        ];

        events.forEach((ev, idx) => {
            lines.push('BEGIN:VEVENT');
            lines.push(`UID:${timestamp}-${idx}@roster.com`);
            lines.push(`DTSTAMP:${timestamp}`);
            lines.push(`SUMMARY:${escapeICS(ev.title)}`);
            
            if (ev.isAllDay) {
                // All Day Event Logic
                lines.push(`DTSTART;VALUE=DATE:${formatDateOnly(ev.start)}`);
                const nextDay = new Date(ev.start);
                nextDay.setDate(nextDay.getDate() + 1);
                lines.push(`DTEND;VALUE=DATE:${formatDateOnly(nextDay)}`);
                lines.push('X-MICROSOFT-CDO-ALLDAYEVENT:TRUE');
                lines.push('TRANSP:TRANSPARENT'); // Show as free, not busy
            } else {
                // Timed Event Logic
                lines.push(`DTSTART:${formatDateICS(ev.start)}`);
                lines.push(`DTEND:${formatDateICS(ev.end)}`);
                lines.push('TRANSP:OPAQUE'); // Show as busy
            }
            lines.push('END:VEVENT');
        });

        lines.push('END:VCALENDAR');
        return lines.join('\r\n');
    }

    function formatDateICS(d) {
        const pad = n => n.toString().padStart(2, '0');
        return d.getUTCFullYear() + pad(d.getUTCMonth() + 1) + pad(d.getUTCDate()) + 'T' +
               pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + 'Z';
    }

    function formatDateOnly(d) {
        const pad = n => n.toString().padStart(2, '0');
        return d.getFullYear() + pad(d.getMonth() + 1) + pad(d.getDate());
    }

    function escapeICS(t) { return t.replace(/[\\,;]/g, '\\$&').replace(/\n/g, '\\n'); }
    
    function showStatus(msg, type) {
        const el = document.getElementById('status');
        el.textContent = msg; el.className = type; el.style.display = 'block';
        if (type === 'success') setTimeout(() => el.style.display = 'none', 10000);
    }
</script>
</body>
</html>
