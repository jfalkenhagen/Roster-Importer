<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Roster → Calendar</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --card2:#0f172a;
      --text:#e8eefc;
      --muted:#a9b4d0;
      --accent:#6ea8fe;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(110,168,254,.20), transparent 60%),
                  radial-gradient(1000px 600px at 90% 10%, rgba(52,211,153,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height:1.35;
    }
    header{
      padding: 18px 16px 8px;
    }
    .title{
      font-size: 20px;
      font-weight: 750;
      letter-spacing: .2px;
      margin: 0 0 6px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 13px;
    }
    main{
      padding: 12px 16px 28px;
      max-width: 760px;
      margin: 0 auto;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 12px 0;
      backdrop-filter: blur(8px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex: 1 1 220px; }
    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin: 8px 0 6px;
    }
    input[type="text"], input[type="file"]{
      width:100%;
      padding: 14px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.65);
      color: var(--text);
      font-size: 16px; /* prevents iOS zoom-on-focus */
      outline: none;
    }
    input[type="text"]:focus{
      border-color: rgba(110,168,254,.75);
      box-shadow: 0 0 0 4px rgba(110,168,254,.15);
    }
    .btn{
      width:100%;
      border:0;
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 700;
      color:#081024;
      background: linear-gradient(180deg, #8bb8ff, #6ea8fe);
      box-shadow: 0 10px 20px rgba(110,168,254,.25);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .btn.secondary{
      background: transparent;
      color: var(--text);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(17,26,46,.5);
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .status{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.55);
      color: var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
    }
    .status.good{ border-color: rgba(52,211,153,.35); color: #c9ffe8; }
    .status.warn{ border-color: rgba(251,191,36,.35); color: #fff3cf; }
    .status.bad{  border-color: rgba(251,113,133,.35); color: #ffe0e7; }
    .small{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
    }
    datalist option{ font-size: 16px; }
    .footerNote{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    <p class="title">Roster → Calendar</p>
    <p class="subtitle">Choose the roster file, type your name, generate an .ics calendar file.</p>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <div>
          <label for="file">1) Select roster (.xlsx)</label>
          <input id="file" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
          <div class="pill" id="filePill">No file selected</div>
        </div>
        <div>
          <label for="name">2) Your name</label>
          <input id="name" type="text" inputmode="text" autocomplete="off"
                 placeholder="e.g. Angela Thomson or Thomson, Angela"
                 list="nameList" />
          <datalist id="nameList"></datalist>
          <div class="small">Tip: after 3 letters, you’ll get suggestions. You can type “Last, First” or “First Last”.</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <button class="btn" id="generateBtn" disabled>Generate calendar (.ics)</button>
      <div style="height:10px"></div>
      <button class="btn secondary" id="resetBtn">Reset</button>

      <div id="status" class="status">Ready.</div>
      <div class="footerNote">
        Works best as a web link (GitHub Pages / Cloudflare Pages) or as an iOS Shortcut “app”.
      </div>
    </div>
  </main>

  <!-- SheetJS (XLSX parser) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, type="") {
      const el = $("status");
      el.className = "status" + (type ? " " + type : "");
      el.textContent = msg;
    }

    function normalizeName(s){
      return (s || "")
        .trim()
        .replace(/\s+/g, " ")
        .toLowerCase();
    }

    function canonicalizeName(s){
      // Converts "Last, First" -> "first last" for matching
      s = (s || "").trim();
      if (!s) return "";
      if (s.includes(",")) {
        const [last, first] = s.split(",").map(x => x.trim()).filter(Boolean);
        return normalizeName([first, last].filter(Boolean).join(" "));
      }
      return normalizeName(s);
    }

    // Basic Levenshtein distance for typo suggestions
    function levenshtein(a, b){
      a = a || ""; b = b || "";
      const m = a.length, n = b.length;
      const dp = Array.from({length:m+1}, () => new Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++){
        for (let j=1;j<=n;j++){
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i-1][j] + 1,
            dp[i][j-1] + 1,
            dp[i-1][j-1] + cost
          );
        }
      }
      return dp[m][n];
    }

    function bestNameMatches(inputCanon, canonToDisplay, limit=5){
      const keys = Array.from(canonToDisplay.keys());
      const scored = keys.map(k => ({
        canon: k,
        display: canonToDisplay.get(k),
        d: levenshtein(inputCanon, k)
      }));
      scored.sort((a,b)=>a.d-b.d);
      return scored.slice(0, limit);
    }

    // ---------- ICS generation ----------
    function icsEscape(s=""){
      return String(s)
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;");
    }

    function toICSDate(dt){
      // dt is a JS Date in local time; output floating local time (no Z)
      const pad = (n)=> String(n).padStart(2,"0");
      return dt.getFullYear()
        + pad(dt.getMonth()+1)
        + pad(dt.getDate())
        + "T"
        + pad(dt.getHours())
        + pad(dt.getMinutes())
        + "00";
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/calendar;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function buildICS(events){
      const lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//RosterImporter//EN",
        "CALSCALE:GREGORIAN"
      ];
      for (const ev of events){
        lines.push("BEGIN:VEVENT");
        lines.push("UID:" + (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random())));
        lines.push("DTSTAMP:" + toICSDate(new Date()));
        lines.push("SUMMARY:" + icsEscape(ev.summary || "Shift"));
        lines.push("DTSTART:" + toICSDate(ev.start));
        lines.push("DTEND:" + toICSDate(ev.end));
        if (ev.location) lines.push("LOCATION:" + icsEscape(ev.location));
        if (ev.description) lines.push("DESCRIPTION:" + icsEscape(ev.description));
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }

    // ---------- Roster parsing scaffold ----------
    // This is the only part that depends on your spreadsheet structure.
    // We’ll extract:
    //  - a list of staff names found
    //  - events for the selected staff member
    function parseRoster(workbook){
      // Choose first sheet by default
      const sheetName = workbook.SheetNames[0];
      const ws = workbook.Sheets[sheetName];

      // Read as a 2D array so we can scan cells
      const grid = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
      // Find candidate names by scanning first column-ish blocks for "SURNAME, First"
      // Your example appears to contain names like "THOMSON, Angela" [2]
      const foundNames = new Set();

      for (let r=0;r<grid.length;r++){
        for (let c=0;c<Math.min(grid[r].length, 8); c++){
          const v = String(grid[r][c] ?? "").trim();
          if (/^[A-Z][A-Z'\-\s]+,\s*[A-Za-z].+/.test(v)) {
            foundNames.add(v);
          }
        }
      }

      return { sheetName, grid, foundNames: Array.from(foundNames) };
    }

    // TODO: implement based on your specific roster layout (dates row, shift cells, etc.)
    function extractShiftsForPerson({grid}, personDisplayName){
      // Return array of {start: Date, end: Date, summary: string}
      // Placeholder:
      return [];
    }

    // ---------- App state ----------
    let roster = null; // {workbook, parsed, canonToDisplay}

    function refreshDatalist(prefix){
      const dl = $("nameList");
      dl.innerHTML = "";
      if (!roster) return;

      const p = canonicalizeName(prefix);
      if (p.length < 3) return;

      const options = [];
      for (const [canon, display] of roster.canonToDisplay.entries()){
        if (canon.includes(p)) options.push(display);
        if (options.length >= 25) break;
      }
      for (const display of options){
        const opt = document.createElement("option");
        opt.value = display;
        dl.appendChild(opt);
      }
    }

    $("file").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      roster = null;
      $("generateBtn").disabled = true;

      if (!file){
        $("filePill").textContent = "No file selected";
        setStatus("Ready.");
        return;
      }
      $("filePill").textContent = file.name;

      try{
        setStatus("Loading roster…");
        const buf = await file.arrayBuffer();
        const workbook = XLSX.read(buf, {type:"array"});
        const parsed = parseRoster(workbook);

        const canonToDisplay = new Map();
        for (const display of parsed.foundNames){
          canonToDisplay.set(canonicalizeName(display), display);
          // also allow "First Last" display variant
          const disp = display;
          if (disp.includes(",")){
            const [last, first] = disp.split(",").map(s=>s.trim());
            const fl = [first, last].filter(Boolean).join(" ");
            canonToDisplay.set(canonicalizeName(fl), disp); // map "first last" to original display
          }
        }

        roster = { workbook, parsed, canonToDisplay };
        $("generateBtn").disabled = false;

        setStatus(
          `Roster loaded.\nSheet: ${parsed.sheetName}\nNames found: ${parsed.foundNames.length}\n\nType at least 3 letters to see suggestions.`,
          "good"
        );

      } catch(err){
        console.error(err);
        setStatus("Couldn’t read that file. Please make sure it’s an .xlsx roster export.", "bad");
      }
    });

    $("name").addEventListener("input", (e)=>{
      refreshDatalist(e.target.value);
    });

    $("resetBtn").addEventListener("click", ()=>{
      $("file").value = "";
      $("name").value = "";
      $("nameList").innerHTML = "";
      $("filePill").textContent = "No file selected";
      $("generateBtn").disabled = true;
      roster = null;
      setStatus("Ready.");
    });

    $("generateBtn").addEventListener("click", ()=>{
      if (!roster){
        setStatus("Please select a roster file first.", "warn");
        return;
      }
      const nameRaw = $("name").value;
      const nameCanon = canonicalizeName(nameRaw);

      if (!nameCanon){
        setStatus("Please enter your name.", "warn");
        $("name").focus();
        return;
      }

      // Exact match?
      const exactDisplay = roster.canonToDisplay.get(nameCanon);
      if (!exactDisplay){
        const best = bestNameMatches(nameCanon, roster.canonToDisplay, 5);
        const suggestions = best.map(x => `- ${x.display}`).join("\n");
        setStatus(
          `No exact match for: "${nameRaw}"\n\nDid you mean:\n${suggestions}\n\nTip: try typing 3+ letters and pick from the dropdown.`,
          "bad"
        );
        return;
      }

      // Extract shifts -> events
      const events = extractShiftsForPerson(roster.parsed, exactDisplay);

      if (!events.length){
        setStatus(
          `Matched: ${exactDisplay}\nBut I couldn’t find any shifts to export.\n\nThis usually means the shift-extraction rules need to be aligned to your roster layout.`,
          "warn"
        );
        return;
      }

      const ics = buildICS(events);
      const safe = exactDisplay.replace(/[^\w\s-]+/g,"").trim().replace(/\s+/g,"-");
      downloadText(`roster-${safe}.ics`, ics);
      setStatus(`Done.\nExported ${events.length} events for ${exactDisplay}.`, "good");
    });
  </script>
</body>
</html>